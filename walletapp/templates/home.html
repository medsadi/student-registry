{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registry - Blockchain Platform</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="cube"></div>
        <div class="cube"></div>
        <div class="cube"></div>
        <div class="cube"></div>
        <div class="cube"></div>
    </div>

    <!-- MetaMask Detection Modal -->
    <div id="metamaskModal" class="metamask-modal" style="display: none;">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <i class="fab fa-ethereum"></i>
                <h2>MetaMask Required</h2>
            </div>
            <div class="modal-body">
                <p>This application requires MetaMask to be installed.</p>
                <p>Please install MetaMask extension to continue.</p>
                <a href="https://metamask.io/download/" target="_blank" class="btn btn-primary">
                    <i class="fas fa-download"></i> Install MetaMask
                </a>
            </div>
        </div>
    </div>

    <!-- Transaction Confirmation Modal -->
    <div id="confirmationModal" class="metamask-modal" style="display: none;">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <i class="fas fa-clock"></i>
                <h2>Confirm Transaction</h2>
            </div>
            <div class="modal-body">
                <div class="loading-spinner"></div>
                <p>Please confirm the transaction in MetaMask...</p>
                <p class="text-muted">This window will close automatically after confirmation</p>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>Student Registry</span>
            </div>
            <div class="nav-info">
                <div class="metamask-status">
                    <div id="metamaskStatus" class="network-badge">
                        <i class="fas fa-spinner fa-spin"></i> Connecting...
                    </div>
                    <div id="walletInfo" class="wallet-info" style="display: none;">
                        <span class="wallet-address" id="walletAddress"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="container">
            
            <!-- Header -->
            <header class="page-header">
                <h1>Blockchain Student Registry</h1>
                <p class="subtitle">Decentralized Student Management System on Polygon Amoy</p>
            </header>

            <!-- Statistics Dashboard -->
            <div class="stats-grid">
                <div class="stat-card glass-effect">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ total_students }}</h3>
                        <p>Registered Students</p>
                    </div>
                </div>

                <div class="stat-card glass-effect">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ moyenne_generale }}/20</h3>
                        <p>Overall Average</p>
                    </div>
                </div>

                <div class="stat-card glass-effect">
                    <div class="stat-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Polygon</h3>
                        <p>Blockchain Network</p>
                    </div>
                </div>
            </div>

            <!-- Messages (Success/Error) -->
            {% if messages %}
                <div class="messages-container">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} glass-effect">
                            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            <span>{{ message }}</span>
                            <button class="close-alert" onclick="this.parentElement.remove()">Ã—</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="content-grid">
                
                <!-- Left Column: Form -->
                <div class="form-section glass-effect">
                    <div class="section-header">
                        <h2><i class="fas fa-user-plus"></i> Add New Student</h2>
                        <p>Information will be stored on the blockchain</p>
                    </div>

                    <form method="POST" class="student-form">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="nom">
                                <i class="fas fa-user"></i> Last Name
                            </label>
                            <input 
                                type="text" 
                                id="nom" 
                                name="nom" 
                                placeholder="e.g. ALAMI" 
                                required
                                class="form-input"
                            >
                        </div>

                        <div class="form-group">
                            <label for="prenom">
                                <i class="fas fa-user"></i> First Name
                            </label>
                            <input 
                                type="text" 
                                id="prenom" 
                                name="prenom" 
                                placeholder="e.g. Ahmed" 
                                required
                                class="form-input"
                            >
                        </div>

                        <div class="form-group">
                            <label for="dateNaissance">
                                <i class="fas fa-calendar"></i> Date of Birth
                            </label>
                            <input 
                                type="text" 
                                id="dateNaissance" 
                                name="dateNaissance" 
                                placeholder="DD/MM/YYYY" 
                                required
                                class="form-input"
                            >
                        </div>

                        <div class="form-group">
                            <label for="moyenne">
                                <i class="fas fa-chart-bar"></i> Overall Average (out of 20)
                            </label>
                            <input 
                                type="number" 
                                id="moyenne" 
                                name="moyenne" 
                                placeholder="e.g. 15.75" 
                                step="0.01"
                                min="0"
                                max="20"
                                required
                                class="form-input"
                            >
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save to Blockchain
                        </button>

                        <div class="form-info">
                            <i class="fas fa-info-circle"></i>
                            <span>Transaction will be confirmed in 10-30 seconds</span>
                        </div>
                    </form>
                </div>

                <!-- Right Column: Table -->
                <div class="table-section glass-effect">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Registered Students</h2>
                        <p>{{ students|length }} student{{ students|length|pluralize }} on blockchain</p>
                    </div>

                    {% if students %}
                        <div class="table-container">
                            <table class="students-table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-hashtag"></i> ID</th>
                                        <th><i class="fas fa-user"></i> Last Name</th>
                                        <th><i class="fas fa-user"></i> First Name</th>
                                        <th><i class="fas fa-calendar"></i> Date of Birth</th>
                                        <th><i class="fas fa-star"></i> Average</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    <tr class="fade-in">
                                        <td><span class="badge">{{ student.id }}</span></td>
                                        <td class="student-name">{{ student.nom }}</td>
                                        <td class="student-name">{{ student.prenom }}</td>
                                        <td>{{ student.dateNaissance }}</td>
                                        <td>
                                            <span class="moyenne-badge 
                                                {% if student.moyenne >= 16 %}excellent
                                                {% elif student.moyenne >= 14 %}good
                                                {% elif student.moyenne >= 10 %}average
                                                {% else %}poor{% endif %}">
                                                {{ student.moyenne }}/20
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No Students Registered</h3>
                            <p>Start by adding a student using the form</p>
                        </div>
                    {% endif %}
                </div>

            </div>

            <!-- Footer Info -->
            <footer class="page-footer glass-effect">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4><i class="fas fa-link"></i> Blockchain Information</h4>
                        <p>Smart Contract: <code>{{ CONTRACT_ADDRESS|slice:":8" }}...{{ CONTRACT_ADDRESS|slice:"-6:" }}</code></p>
                        <p>Network: Polygon Amoy Testnet</p>
                        <p>Chain ID: 80002</p>
                    </div>
                    <div class="footer-section">
                        <h4><i class="fas fa-info-circle"></i> Key Features</h4>
                        <ul>
                            <li><i class="fas fa-check"></i> Decentralized Storage</li>
                            <li><i class="fas fa-check"></i> Immutable Data</li>
                            <li><i class="fas fa-check"></i> 100% Blockchain</li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h4><i class="fas fa-code"></i> Technology Stack</h4>
                        <ul>
                            <li>Django Framework</li>
                            <li>Web3.py Library</li>
                            <li>Solidity Smart Contracts</li>
                            <li>Polygon Amoy Network</li>
                            <li>Alchemy RPC Provider</li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2025 Student Registry Blockchain Platform | Professional Implementation</p>
                </div>
            </footer>

        </div>
    </div>

    <!-- Bouton Flottant Admin -->
    <a href="{% url 'blockchain:admin_diploma' %}" class="admin-button">
        <i class="fas fa-user-shield"></i>
        Admin Panel
    </a>

    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/metamask.js' %}"></script>
</body>
</html>